{% extends "base.html" %}
{% block title %}Shipments ‚Äî Shipment Manager{% endblock %}
{% block content %}
<div class="container mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Shipments</h2>
    <div>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">üè† Home</a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('create_shipment') }}">Create Shipment</a>
      <a class="btn btn-link btn-sm" href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>
  </div>

  <!-- Search / Filter / Sort form -->
  <form class="shipment-search-form mb-3 p-3 bg-white rounded" method="get" action="{{ url_for('list_shipments') }}">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="search">Search</label>
        <input id="search" name="q" type="search" class="form-control" placeholder="Search description..." value="{{ search_query or '' }}">
      </div>

      <div class="col-md-3">
        <label class="form-label" for="status">Status</label>
        <select id="status" name="status" class="form-select">
          <option value="">All</option>
          <option value="Pending" {% if status_filter=='Pending' %}selected{% endif %}>Pending</option>
          <option value="In-Transit" {% if status_filter=='In-Transit' %}selected{% endif %}>In-Transit</option>
          <option value="Delivered" {% if status_filter=='Delivered' %}selected{% endif %}>Delivered</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label" for="sort">Sort by</label>
        <select id="sort" name="sort_by" class="form-select">
          <option value="date_desc" {% if sort_by=='date_desc' %}selected{% endif %}>Date: Newest</option>
          <option value="date_asc" {% if sort_by=='date_asc' %}selected{% endif %}>Date: Oldest</option>
          <option value="cost_desc" {% if sort_by=='cost_desc' %}selected{% endif %}>Total Cost: High ‚Üí Low</option>
          <option value="cost_asc" {% if sort_by=='cost_asc' %}selected{% endif %}>Total Cost: Low ‚Üí High</option>
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-primary" type="submit" style="height:38px;">Apply</button>
      </div>
    </div>
  </form>

  <!-- Shipments list -->
  <div class="list-group bg-white rounded p-2">
    {% if pagination.items %}
      {% for item in pagination.items %}
        <div class="list-group-item d-flex justify-content-between align-items-start">
          <div class="ms-2 me-auto">
            <div class="fw-bold">{{ item.description }}</div>
            <div class="small text-muted">ID: {{ item.id }} ‚Ä¢ Created: {{ item.created_at.strftime('%Y-%m-%d') }}</div>
            <div class="small mt-1">Total: ‚Çπ{{ item.total_cost }}</div>

            <!-- Status badge (safe access if status is None) -->
            {% set st = (item.status.value if item.status else 'Unknown') %}
            {% if st == 'Pending' %}
              <span class="badge bg-warning text-dark mt-2">Pending</span>
            {% elif st == 'In-Transit' %}
              <span class="badge bg-info text-dark mt-2">In-Transit</span>
            {% elif st == 'Delivered' %}
              <span class="badge bg-success mt-2">Delivered</span>
            {% else %}
              <span class="badge bg-secondary mt-2">{{ st }}</span>
            {% endif %}
          </div>

          <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
            <!-- use url_for directly (routes exist in app.py) -->
            <a class="btn btn-outline-primary" href="{{ url_for('view_shipment', shipment_id=item.id) }}">View</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('edit_shipment', shipment_id=item.id) }}">Edit</a>

            <form method="post" action="{{ url_for('delete_shipment', shipment_id=item.id) }}" style="display:inline;">
              <button class="btn btn-outline-danger" type="submit" onclick="return confirm('Delete shipment #{{ item.id }}?');">Delete</button>
            </form>
          </div>
        </div>

      {% endfor %}
    {% else %}
      <div class="p-3 text-center text-muted">No shipments found.</div>
    {% endif %}
  </div>

  <!-- Pagination controls -->
  <nav aria-label="Shipments pagination" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('list_shipments', page=pagination.prev_num, q=search_query, status=status_filter, sort_by=sort_by) }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} of {{ pagination.pages or 1 }}</span></li>

      {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('list_shipments', page=pagination.next_num, q=search_query, status=status_filter, sort_by=sort_by) }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endblock %}
